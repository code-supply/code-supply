#!/usr/bin/env bash

name="$1"

query="$(cat <<SQL
SELECT
u.email
FROM sites s
INNER JOIN site_members sm ON sm.site_id = s.id
INNER JOIN users u ON u.id = sm.user_id
SQL
)"

if [ ! -z "$name" ]
then
    query+=" WHERE s.internal_name = :'sitename'"
fi

psql \
    --host unhinged \
    --username hosting \
    --variable=sitename="$1" \
    --no-align \
    --tuples-only \
    <<< "$query" \
    | sort
